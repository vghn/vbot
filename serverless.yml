service: vbot

custom:
  # Stage
  stage: ${opt:stage, env:SLS_STAGE, 'dev'}
  # Secrets Bucket Name
  secrets_bucket: ${self:service}-${self:custom.stage}-secrets
  # Domain Name
  domain_name: ghn.me
  # serverless-python-requirements plugin (package dependencies)
  pythonRequirements:
    dockerizePip: true
    zip: true
  # serverless-prune-plugin (prune old deployments)
  prune:
    automatic: true
    number: 10

package:
  individually: false
  exclude:
    - '**/*'
  include:
    - handler.py

provider:
  name: aws
  runtime: python3.6
  memorySize: 128
  stackTags:
    PROJECT: VBot
  iamRoleStatements:
    - Effect: Allow
      Action:
        - s3:GetObject
      Resource: arn:aws:s3:::${self:custom.secrets_bucket}/*
    - Effect: Allow
      Action:
        - ssm:Get*
      Resource: arn:aws:ssm:*:*:parameter/${self:service}/*
  environment:
    SERVICE_NAME: ${self:service}
    SECRETS_BUCKET: ${self:custom.secrets_bucket}

functions:
  slack:
    handler: handler.slack
    events:
      - schedule: rate(15 minutes)
      - http:
          path: slack
          method: post
  travis:
    handler: handler.travis
    events:
      - schedule: rate(15 minutes)
      - http:
          path: travis
          method: post
  api:
    handler: handler.api
    events:
      - schedule: rate(15 minutes)
      - http:
          path: api
          method: get
  cron:
    handler: handler.run
    events:
      - schedule: rate(15 minutes)

resources:
  Resources:
    Secrets:
      Type: AWS::S3::Bucket
      DeletionPolicy: Retain
      Properties:
        BucketName: ${self:custom.secrets_bucket}
        AccessControl: Private
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
    SecretsBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket:
          Ref: Secrets
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Sid: DenyUnEncryptedInflightOperations
            Effect: Deny
            Principal: '*'
            Action: s3:*
            Resource: arn:aws:s3:::${self:custom.secrets_bucket}/*
            Condition:
              Bool:
                aws:SecureTransport: false
          - Sid: DenyUnEncryptedObjectUploads
            Effect: Deny
            Principal: '*'
            Action:
            - s3:PutObject
            Resource: arn:aws:s3:::${self:custom.secrets_bucket}/*
            Condition:
              StringNotEquals:
                s3:x-amz-server-side-encryption: AES256
    Certificate:
      Type: AWS::CertificateManager::Certificate
      Properties:
        DomainName: ${self:service}.${self:custom.domain_name}
        DomainValidationOptions:
          - DomainName: ${self:service}.${self:custom.domain_name}
            ValidationDomain: ${self:custom.domain_name}
        Tags:
          - Key: Name
            Value: ${self:service}
    DomainName:
      Type: AWS::ApiGateway::DomainName
      Properties:
        CertificateArn:
          Ref: Certificate
        DomainName: ${self:service}.${self:custom.domain_name}
    BasePathMapping:
      Type: AWS::ApiGateway::BasePathMapping
      Properties:
        DomainName:
          Ref: DomainName
        RestApiId:
          Ref: ApiGatewayRestApi
        Stage: ${self:custom.stage}

plugins:
  - serverless-python-requirements
  - serverless-prune-plugin
