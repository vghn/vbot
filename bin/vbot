#!/usr/bin/env bash

# Bash strict mode
set -euo pipefail
IFS=$'\n\t'

# DEBUG
[ -z "${DEBUG:-}" ] || set -x

# VARs
VBOT_AWS_ACCESS_KEY_ID="${VBOT_AWS_ACCESS_KEY_ID:-}"
VBOT_AWS_SECRET_ACCESS_KEY="${VBOT_AWS_SECRET_ACCESS_KEY:-}"
VBOT_AWS_ROLE_ARN="${VBOT_AWS_ROLE_ARN:-}"
ENCRYPT_KEY="${ENCRYPT_KEY:-}"
APPDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)/.."
GIT_BRANCH="${TRAVIS_BRANCH:-$(git symbolic-ref --short HEAD)}"

# Usage
usage(){
  echo '---------------------------------------------'
  echo "USAGE: ${BASH_SOURCE[0]} [COMMAND] [SUBCOMMAND] [OPTIONS]"
  echo '---------------------------------------------'
  echo 'Commands:'
  echo ''
  echo '  - deploy [FUNCTION NAME]'
  echo ''
  echo '  - help'
  echo ''
  echo '----------------------------------------------'
  echo 'For more information please consult the README'
  echo '----------------------------------------------'
  exit 1
}

# Load VGS library (https://github.com/vghn/vgs)
# shellcheck disable=1090
. "${VGS_PATH:-${HOME}/vgs}/load" || { echo 'VGS library is required' >&2; exit 1; }

# Detect stage
detect_stage(){
  if [[ "${TRAVIS_PULL_REQUEST:-false}" == 'false' ]]; then
    if [[ "$GIT_BRANCH" == 'master' ]]; then
      export SLS_STAGE='prod'
    elif [[ "$GIT_BRANCH" == 'dev' ]]; then
      export SLS_STAGE='dev'
    fi
  fi
}

# Deploy
deploy_vbot(){
  local func="${1:-}"
  if [[ -z ${SLS_STAGE+x} ]]; then
    echo "Not deploying changes from ${GIT_BRANCH} (only master/dev)"
  else
    echo "Deploying stage from branch '${GIT_BRANCH}' to '${SLS_STAGE}'"

    npm install

    vgs_aws_credentials "$VBOT_AWS_ACCESS_KEY_ID" "$VBOT_AWS_SECRET_ACCESS_KEY" "$VBOT_AWS_ROLE_ARN"

    if [[ -n "$func" ]]; then
      serverless deploy function --stage "$SLS_STAGE" --function "$func" --verbose
    else
      serverless deploy --stage "$SLS_STAGE" --verbose
    fi
  fi
}

# Logs
vbot_logs(){
  local func="${1:-}"
  serverless logs --stage "$SLS_STAGE" --function "$func" --tail
}

# Process VBot CLI
vbot_process_cli(){
  export cmd="${1:-}"; shift || true
  export scmd="${1:-}"; shift || true

  load_env
  detect_stage

  case "$cmd" in
    deploy)
      deploy_vbot "$scmd"
      ;;
    logs)
      vbot_logs "$scmd"
      ;;
    help)
      usage
      ;;
    *)
      usage
      ;;
  esac
}

vbot_process_cli "${@:-}"
